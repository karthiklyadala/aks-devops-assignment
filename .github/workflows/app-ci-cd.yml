name: app-ci-cd
on:
  push:
    paths:
      - 'app/**'
      - 'k8s/**'
  pull_request:
    paths:
      - 'app/**'

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      IMAGE: web
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python for tests
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps & run tests
        working-directory: app/src
        run: |
          python -m pip install -r requirements.txt
          python - <<'PY'
print('smoke test OK')
PY

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: az cli
        uses: azure/cli@v2
        with:
          azcliversion: 2.64.0
          inlineScript: |
            az acr login --name $(az acr list --query "[0].name" -o tsv)
            ACR=$(az acr list --query "[0].loginServer" -o tsv)
            echo "ACR=$ACR" >> $GITHUB_ENV

      - name: Build & push
        run: |
          docker build -t $ACR/${{ env.IMAGE }}:${{ github.sha }} -t $ACR/${{ env.IMAGE }}:latest app
          docker push $ACR/${{ env.IMAGE }}:${{ github.sha }}
          docker push $ACR/${{ env.IMAGE }}:latest

      - name: Get AKS creds
        run: |
          RG=${{ vars.RG }}
          AKS_NAME=${{ vars.AKS_NAME }}
          if [ -z "$RG" ] || [ -z "$AKS_NAME" ]; then
            echo "Set repo variables RG and AKS_NAME (or output via TF in a previous job)"; exit 1
          fi
          az aks get-credentials -g $RG -n $AKS_NAME --overwrite-existing

      - name: Substitute image & apply manifests
        run: |
          sed -i "s|REPLACE_WITH_ACR|$ACR|g" k8s/deployment.yaml
          kubectl apply -k k8s
          kubectl -n app rollout status deploy/web --timeout=120s
          kubectl -n app get svc,ingress,pods -o wide
